{%- render 'megamenu-styles' -%}

{%- liquid
  unless limit
    assign limit = main_menu.links.size
  endunless
  unless offset
    assign offset = 0
  endunless
-%}

<ul
  class="site-nav site-navigation small--hide"
  {% unless disable_aria %}
    role="navigation" aria-label="Primary"
  {% endunless %}
>
  {%- for link in main_menu.links limit: limit offset: offset -%}
    {%- liquid
      assign has_dropdown = false
      assign is_megamenu = false
      if link.links != blank
        assign has_dropdown = true
        if link.levels > 1
          assign is_megamenu = true
        endif
      endif
    -%}

    <li
      class="site-nav__item site-nav__expanded-item{% if has_dropdown %} site-nav--has-dropdown{% endif %}{% if is_megamenu %} site-nav--is-megamenu{% endif %}"
      {% if has_dropdown %}
        aria-haspopup="true"
      {% endif %}
    >
      <a
        href="{{ link.url }}"
        class="site-nav__link site-nav__link--underline{% if has_dropdown %} site-nav__link--has-dropdown{% endif %}"
      >
        {{ link.title }}
      </a>
      {%- if is_megamenu -%}
        {%- assign collection_count = 0 -%}
        {%- assign featured_collection = null -%}
        {%- assign featured_product = null -%}

        <div class="site-nav__dropdown megamenu megamenu--modern text-left">
          <div class="page-width">
            <div class="megamenu__layout">
              {%- comment -%} LEFT COLUMN: Menu Links - Show ALL child links {%- endcomment -%}
              <div class="megamenu__sidebar appear-animation appear-delay-1">
                {%- for childlink in link.links -%}
                  <a href="{{ childlink.url }}" class="megamenu__sidebar-link">
                    <span class="megamenu__sidebar-title">{{ childlink.title }}</span>
                    {%- if childlink.links.size > 0 -%}
                      <span class="megamenu__sidebar-subtitle">{{ childlink.links.size }} items</span>
                    {%- endif -%}
                  </a>
                {%- endfor -%}
              </div>

              {%- comment -%} CENTER COLUMN: Collection/Menu Images Grid {%- endcomment -%}
              <div class="megamenu__collections appear-animation appear-delay-2">
                <div class="megamenu__collections-grid">
                  {%- for childlink in link.links -%}
                    {%- assign has_image = false -%}
                    {%- assign tile_image = null -%}

                    {%- comment -%} Try to get image from collection {%- endcomment -%}
                    {%- if childlink.url contains '/collections/' -%}
                      {%- assign col_handle = childlink.object.handle -%}
                      {%- assign col = collections[col_handle] -%}

                      {%- if col.image != blank -%}
                        {%- assign tile_image = col.image -%}
                        {%- assign has_image = true -%}
                      {%- elsif col.products.first.featured_image != blank -%}
                        {%- assign tile_image = col.products.first.featured_image -%}
                        {%- assign has_image = true -%}
                      {%- endif -%}

                      {%- comment -%} Save first collection for featured {%- endcomment -%}
                      {%- if featured_collection == null and col != blank -%}
                        {%- assign featured_collection = col -%}
                      {%- endif -%}
                    {%- endif -%}

                    {%- comment -%} Try to get image from product link {%- endcomment -%}
                    {%- if has_image == false and childlink.url contains '/products/' -%}
                      {%- assign prod = childlink.object -%}
                      {%- if prod.featured_image != blank -%}
                        {%- assign tile_image = prod.featured_image -%}
                        {%- assign has_image = true -%}
                      {%- endif -%}
                      {%- if featured_product == null -%}
                        {%- assign featured_product = prod -%}
                      {%- endif -%}
                    {%- endif -%}

                    <a href="{{ childlink.url }}" class="megamenu__collection-tile">
                      <div class="megamenu__collection-image-wrap">
                        {%- if has_image and tile_image != blank -%}
                          <img
                            src="{{ tile_image | img_url: '200x200', crop: 'center' }}"
                            alt="{{ childlink.title }}"
                            class="megamenu__collection-img"
                            width="90"
                            height="90"
                            loading="lazy"
                          >
                        {%- else -%}
                          <div class="megamenu__collection-placeholder">
                            <span class="megamenu__placeholder-text">{{ childlink.title | slice: 0 }}</span>
                          </div>
                        {%- endif -%}
                      </div>
                      <span class="megamenu__collection-title">{{ childlink.title }}</span>
                    </a>
                    {%- assign collection_count = collection_count | plus: 1 -%}
                  {%- endfor -%}

                  {%- comment -%} See All tile {%- endcomment -%}
                  <a href="{{ link.url }}" class="megamenu__collection-tile megamenu__collection-tile--see-all">
                    <div class="megamenu__collection-image-wrap">
                      <div class="megamenu__see-all-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="12" y1="5" x2="12" y2="19"></line>
                          <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                      </div>
                    </div>
                    <span class="megamenu__collection-title">See All</span>
                  </a>
                </div>
              </div>

              {%- comment -%} RIGHT COLUMN: Featured Product/Collection {%- endcomment -%}
              <div class="megamenu__featured appear-animation appear-delay-3">
                {%- if featured_collection != null -%}
                  {%- assign featured_product = featured_collection.products.first -%}
                  {%- if featured_product != blank -%}
                    <a href="{{ featured_product.url }}" class="megamenu__featured-card">
                      <div class="megamenu__featured-image-wrap">
                        <img
                          src="{{ featured_product.featured_image | img_url: '400x500', crop: 'center' }}"
                          alt="{{ featured_product.title }}"
                          class="megamenu__featured-img"
                          width="200"
                          height="280"
                          loading="lazy"
                        >
                      </div>
                      <div class="megamenu__featured-content">
                        <span class="megamenu__featured-title">{{ featured_product.title }}</span>
                      </div>
                    </a>
                  {%- endif -%}
                {%- endif -%}
              </div>
            </div>
          </div>
        </div>
      {%- elsif has_dropdown -%}
        <ul class="site-nav__dropdown text-left">
          {%- for childlink in link.links -%}
            {%- liquid
              assign has_sub_dropdown = false
              if childlink.links != blank
                assign has_sub_dropdown = true
              endif
            -%}

            <li class="{% if has_sub_dropdown %} site-nav__deep-dropdown-trigger{% endif %}">
              <a
                href="{{ childlink.url }}"
                class="site-nav__dropdown-link site-nav__dropdown-link--second-level{% if has_sub_dropdown %} site-nav__dropdown-link--has-children{% endif %}"
              >
                {{ childlink.title | escape }}
                {%- if has_sub_dropdown -%}
                  <svg
                    aria-hidden="true"
                    focusable="false"
                    role="presentation"
                    class="icon icon--wide icon-chevron-down"
                    viewBox="0 0 28 16"
                  >
                    <path d="M1.57 1.59l12.76 12.77L27.1 1.59" stroke-width="2" stroke="#000" fill="none" fill-rule="evenodd"/>
                  </svg>
                {%- endif -%}
              </a>
              {%- if has_sub_dropdown -%}
                <ul class="site-nav__deep-dropdown">
                  {%- for grandchildlink in childlink.links -%}
                    <li>
                      <a href="{{ grandchildlink.url }}" class="site-nav__dropdown-link">
                        {{- grandchildlink.title | escape -}}
                      </a>
                    </li>
                  {%- endfor -%}
                </ul>
              {%- endif -%}
            </li>
          {%- endfor -%}
        </ul>
      {%- endif -%}
    </li>
  {%- endfor -%}
</ul>
